{% extends "hospital/doctor_base.html" %}
{% load static %}
{% block title %}Doctor Dashboard{% endblock %}

{% block content %}
<style>
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

/* Header Section */
.dashboard-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border-radius: 20px;
  padding: 3rem;
  color: white;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-xl);
  position: relative;
  overflow: hidden;
}

.dashboard-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
  animation: backgroundMove 20s linear infinite;
}

@keyframes backgroundMove {
  0% { transform: translateX(0) translateY(0); }
  100% { transform: translateX(-100px) translateY(-100px); }
}

.header-content {
  position: relative;
  z-index: 2;
}

.doctor-info h1 {
  margin: 0 0 1rem 0;
  font-size: 2.5rem;
  font-weight: 800;
  background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.doctor-subtitle {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.department-badge {
  background: rgba(255, 255, 255, 0.2);
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-weight: 600;
  backdrop-filter: blur(10px);
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(16, 185, 129, 0.2);
  border-radius: 50px;
  font-size: 0.875rem;
}

.pulse-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
  }
  50% { 
    transform: scale(1.2);
    box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
  }
}

.doctor-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1.5rem;
}

.detail-card {
  background: rgba(255, 255, 255, 0.15);
  padding: 1rem;
  border-radius: 12px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: transform 0.3s ease;
}

.detail-card:hover {
  transform: translateY(-5px);
}

.detail-label {
  font-size: 0.875rem;
  opacity: 0.8;
  margin-bottom: 0.5rem;
}

.detail-value {
  font-size: 1.125rem;
  font-weight: 600;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: var(--shadow-lg);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}

.stat-card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
}

.stat-card.green::before { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
.stat-card.yellow::before { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); }
.stat-card.blue::before { background: linear-gradient(135deg, var(--info) 0%, #0891b2 100%); }
.stat-card.purple::before { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: var(--primary-light);
  color: var(--primary);
}

.stat-card.green .stat-icon { background: #d1fae5; color: var(--success); }
.stat-card.yellow .stat-icon { background: #fef3c7; color: var(--warning); }
.stat-card.blue .stat-icon { background: #cffafe; color: var(--info); }
.stat-card.purple .stat-icon { background: #ede9fe; color: #8b5cf6; }

.stat-trend {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.5rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
}

.trend-up { background: #d1fae5; color: var(--success); }
.trend-down { background: #fee2e2; color: var(--danger); }
.trend-neutral { background: #f1f5f9; color: var(--text-secondary); }

.stat-value {
  font-size: 2.5rem;
  font-weight: 800;
  margin: 0.5rem 0;
  background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stat-label {
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
}

/* Content Grid */
.content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

@media (max-width: 1024px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
}

/* Section Cards */
.section-card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
  background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Buttons */
.btn-modern {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 12px;
  font-weight: 600;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-md);
  cursor: pointer;
}

.btn-modern:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  color: white;
  text-decoration: none;
}

.btn-modern.secondary {
  background: var(--bg-main);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-modern.secondary:hover {
  background: #f1f5f9;
}

/* Appointments Table */
.appointments-table {
  width: 100%;
  border-collapse: collapse;
}

.appointments-table thead {
  background: var(--bg-main);
}

.appointments-table th {
  padding: 1rem;
  text-align: left;
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
}

.appointments-table td {
  padding: 1.25rem 1rem;
  border-bottom: 1px solid var(--border);
  transition: background 0.3s ease;
}

.appointments-table tr:hover td {
  background: var(--bg-main);
}

.appointments-table tr:last-child td {
  border-bottom: none;
}

.patient-cell {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.patient-avatar {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1rem;
  box-shadow: var(--shadow-sm);
}

.patient-info {
  flex: 1;
}

.patient-name {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.patient-meta {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Badges */
.badge {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-pending {
  background: #fef3c7;
  color: #92400e;
}

.badge-confirmed {
  background: #dbeafe;
  color: #1e40af;
}

.badge-completed {
  background: #d1fae5;
  color: #065f46;
}

.badge-cancelled {
  background: #fee2e2;
  color: #991b1b;
}

/* Quick Actions */
.quick-actions {
  display: grid;
  gap: 1rem;
}

.action-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--bg-main);
  border-radius: 12px;
  text-decoration: none;
  color: var(--text-primary);
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.action-item:hover {
  background: white;
  transform: translateX(8px);
  border-color: var(--primary-light);
  text-decoration: none;
  color: var(--text-primary);
  box-shadow: var(--shadow-md);
}

.action-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  background: var(--primary-light);
  color: var(--primary);
  transition: all 0.3s ease;
}

.action-item:hover .action-icon {
  transform: scale(1.1);
}

.action-content {
  flex: 1;
}

.action-title {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.action-description {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Schedule */
.schedule-timeline {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.schedule-item {
  display: flex;
  gap: 1rem;
  padding: 1.25rem;
  background: var(--bg-main);
  border-radius: 12px;
  border-left: 4px solid var(--primary);
  transition: all 0.3s ease;
}

.schedule-item:hover {
  transform: translateX(4px);
  background: white;
  box-shadow: var(--shadow-sm);
}

.schedule-time {
  font-weight: 600;
  color: var(--primary);
  min-width: 80px;
  font-size: 0.875rem;
}

.schedule-content {
  flex: 1;
}

.schedule-title {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.schedule-details {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Empty States */
.empty-state {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

.empty-state-subtext {
  font-size: 0.875rem;
  opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
  .dashboard-container {
    padding: 1rem;
  }
  
  .dashboard-header {
    padding: 2rem 1.5rem;
  }
  
  .doctor-info h1 {
    font-size: 2rem;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .section-card {
    padding: 1.5rem;
  }
}

/* Animation Classes */
.slide-in-left {
  animation: slideInLeft 0.6s ease-out;
}

.slide-in-right {
  animation: slideInRight 0.6s ease-out;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Notification Bell */
.notification-bell {
  position: relative;
  cursor: pointer;
}

.notification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-5px); }
  60% { transform: translateY(-3px); }
}
</style>

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header animate__animated animate__fadeInDown">
    <div class="header-content">
      <div class="doctor-info">
        <h1>Welcome back, Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }}! üë®‚Äç‚öïÔ∏è</h1>
        
        <div class="doctor-subtitle">
          <span class="department-badge">
            <i class="fas fa-stethoscope me-2"></i>{{ doctor.department|default:"General Medicine" }}
          </span>
          <span class="live-indicator">
            <span class="pulse-dot"></span>
            Live Updates Active
          </span>
        </div>

        <div class="doctor-details">
          <div class="detail-card">
            <div class="detail-label">Qualification</div>
            <div class="detail-value" data-doctor-qualification>
              {{ doctor.qualification|default:"MBBS" }}
            </div>
          </div>
          <div class="detail-card">
            <div class="detail-label">Experience</div>
            <div class="detail-value" data-doctor-experience>
              {{ doctor.experience|default:"0" }} years
            </div>
          </div>
          <div class="detail-card">
            <div class="detail-label">Duty Time</div>
            <div class="detail-value" data-doctor-duty>
              {{ doctor.duty_time|default:"9:00 AM - 5:00 PM" }}
            </div>
          </div>
          <div class="detail-card">
            <div class="detail-label">Patient Rating</div>
            <div class="detail-value" data-doctor-rating>
              {{ doctor.rating|default:"4.8" }} ‚≠ê
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card animate__animated animate__fadeInUp" data-aos="fade-up">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-trend trend-up">
          <i class="fas fa-arrow-up"></i>
          12%
        </div>
      </div>
      <div class="stat-value" data-appt-total>{{ total_appointments|default:"0" }}</div>
      <div class="stat-label">Total Appointments</div>
    </div>

    <div class="stat-card yellow animate__animated animate__fadeInUp" data-aos="fade-up" data-aos-delay="100">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-trend trend-neutral">
          <i class="fas fa-minus"></i>
          0%
        </div>
      </div>
      <div class="stat-value" data-appt-pending>{{ pending_appointments|default:"0" }}</div>
      <div class="stat-label">Pending Approval</div>
    </div>

    <div class="stat-card blue animate__animated animate__fadeInUp" data-aos="fade-up" data-aos-delay="200">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-trend trend-up">
          <i class="fas fa-arrow-up"></i>
          8%
        </div>
      </div>
      <div class="stat-value" data-appt-confirmed>{{ confirmed_appointments|default:"0" }}</div>
      <div class="stat-label">Confirmed Today</div>
    </div>

    <div class="stat-card green animate__animated animate__fadeInUp" data-aos="fade-up" data-aos-delay="300">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="stat-trend trend-up">
          <i class="fas fa-arrow-up"></i>
          15%
        </div>
      </div>
      <div class="stat-value" data-appt-completed>{{ completed_appointments|default:"0" }}</div>
      <div class="stat-label">Successfully Treated</div>
    </div>
  </div>

  <!-- Content Grid -->
  <div class="content-grid">
    <!-- Today's Appointments -->
    <div class="section-card animate__animated animate__fadeInLeft" data-aos="fade-right">
      <div class="section-header">
        <h2 class="section-title">Today's Appointments üìã</h2>
        <div class="d-flex gap-2">
          <button class="btn-modern secondary" onclick="refreshAppointments()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <a href="{% url 'doctor-appointment' %}" class="btn-modern">
            <i class="fas fa-eye"></i> View All
          </a>
        </div>
      </div>

      {% if appointments %}
      <div class="table-responsive">
        <table class="appointments-table">
          <thead>
            <tr>
              <th>Patient</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in appointments %}
            <tr data-appointment-id="{{ appointment.id }}" class="animate__animated animate__fadeIn">
              <td>
                <div class="patient-cell">
                  <div class="patient-avatar">
                    {{ appointment.patient.user.first_name.0 }}{{ appointment.patient.user.last_name.0 }}
                  </div>
                  <div class="patient-info">
                    <div class="patient-name">{{ appointment.patient.user.get_full_name }}</div>
                    <div class="patient-meta">
                      <i class="fas fa-phone me-1"></i>{{ appointment.patient.mobile|default:"No phone" }}
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <strong>{{ appointment.date|date:"h:i A" }}</strong>
              </td>
              <td>
                <span class="badge badge-{{ appointment.status }}" data-appointment-status-{{ appointment.id }}>
                  {{ appointment.status|title }}
                </span>
              </td>
              <td>
                <button class="btn-modern secondary btn-sm" onclick="viewAppointment({{ appointment.id }})">
                  <i class="fas fa-eye"></i> View
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <div class="empty-state-text">No appointments scheduled for today</div>
        <div class="empty-state-subtext">New appointments will appear here automatically</div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div>
      <!-- Quick Actions -->
      <div class="section-card animate__animated animate__fadeInRight" data-aos="fade-left" style="margin-bottom: 2rem;">
        <div class="section-header">
          <h2 class="section-title">Quick Actions ‚ö°</h2>
        </div>
        <div class="quick-actions">
          <a href="{% url 'doctor-appointment' %}" class="action-item">
            <div class="action-icon" style="background: #dbeafe; color: var(--primary);">
              <i class="fas fa-calendar-plus"></i>
            </div>
            <div class="action-content">
              <div class="action-title">Manage Appointments</div>
              <div class="action-description">View and schedule appointments</div>
            </div>
            <i class="fas fa-chevron-right text-muted"></i>
          </a>
          
          <a href="{% url 'doctor-patient' %}" class="action-item">
            <div class="action-icon" style="background: #d1fae5; color: var(--success);">
              <i class="fas fa-user-injured"></i>
            </div>
            <div class="action-content">
              <div class="action-title">My Patients</div>
              <div class="action-description">Access patient records</div>
            </div>
            <i class="fas fa-chevron-right text-muted"></i>
          </a>
          
          <a href="{% url 'doctor-view-patient' %}" class="action-item">
            <div class="action-icon" style="background: #fef3c7; color: var(--warning);">
              <i class="fas fa-file-medical"></i>
            </div>
            <div class="action-content">
              <div class="action-title">Medical Records</div>
              <div class="action-description">View treatment history</div>
            </div>
            <i class="fas fa-chevron-right text-muted"></i>
          </a>
          
          <a href="{% url 'doctor-profile' %}" class="action-item">
            <div class="action-icon" style="background: #ede9fe; color: #8b5cf6;">
              <i class="fas fa-user-md"></i>
            </div>
            <div class="action-content">
              <div class="action-title">Update Profile</div>
              <div class="action-description">Edit your information</div>
            </div>
            <i class="fas fa-chevron-right text-muted"></i>
          </a>
        </div>
      </div>

      <!-- Today's Schedule -->
      <div class="section-card animate__animated animate__fadeInRight" data-aos="fade-left" data-aos-delay="200">
        <div class="section-header">
          <h2 class="section-title">Today's Schedule üïí</h2>
          <div class="notification-bell">
            <i class="fas fa-bell text-warning"></i>
            <span class="notification-badge">3</span>
          </div>
        </div>
        <div class="schedule-timeline">
          {% if schedule_items %}
            {% for item in schedule_items %}
            <div class="schedule-item animate__animated animate__fadeInRight" style="animation-delay: {{ forloop.counter0|add:0.2 }}s">
              <div class="schedule-time">{{ item.time }}</div>
              <div class="schedule-content">
                <div class="schedule-title">{{ item.title }}</div>
                <div class="schedule-details">{{ item.details }}</div>
              </div>
            </div>
            {% endfor %}
          {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üìÖ</div>
            <div class="empty-state-text">No schedule items</div>
            <div class="empty-state-subtext">Your schedule is clear today</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modern Modal System -->
<div id="modal-root" style="display:none;"></div>

<script>
// CSRF Token Helper
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

// Modern Modal System
function showModal(title, content, buttons = []) {
  const modalHtml = `
    <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: fadeIn 0.3s ease;">
      <div class="modal-content" style="background: white; border-radius: 20px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow: auto; box-shadow: var(--shadow-xl); animation: slideInUp 0.3s ease;">
        <div class="modal-header" style="margin-bottom: 1.5rem;">
          <h3 style="margin: 0; font-weight: 700; color: var(--text-primary);">${title}</h3>
          <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        <div class="modal-body">${content}</div>
        ${buttons.length > 0 ? `
        <div class="modal-footer" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
          ${buttons.map(btn => `
            <button class="btn-modern ${btn.primary ? '' : 'secondary'}" onclick="${btn.onclick}">
              ${btn.icon ? `<i class="${btn.icon}"></i>` : ''} ${btn.text}
            </button>
          `).join('')}
        </div>
        ` : ''}
      </div>
    </div>
  `;
  
  const root = document.getElementById('modal-root');
  root.innerHTML = modalHtml;
  root.style.display = 'block';
}

function closeModal() {
  const root = document.getElementById('modal-root');
  root.innerHTML = '';
  root.style.display = 'none';
}

// Appointment Functions
function viewAppointment(id) {
  // Show loading state
  showModal('Loading Appointment', `
    <div style="text-align: center; padding: 2rem;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading appointment details...</p>
    </div>
  `);

  // Simulate API call (replace with actual endpoint)
  setTimeout(() => {
    showModal('Appointment Details', `
      <div style="line-height: 1.6;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div>
            <strong>Patient:</strong><br>
            <span>John Doe</span>
          </div>
          <div>
            <strong>Time:</strong><br>
            <span>2:30 PM</span>
          </div>
          <div>
            <strong>Status:</strong><br>
            <span class="badge badge-pending">Pending</span>
          </div>
          <div>
            <strong>Phone:</strong><br>
            <span>+1 234 567 8900</span>
          </div>
        </div>
        <div>
          <strong>Symptoms:</strong><br>
          <p style="background: var(--bg-main); padding: 1rem; border-radius: 8px; margin: 0.5rem 0;">
            Headache, fever, and general discomfort reported by patient.
          </p>
        </div>
      </div>
    `, [
      {
        text: 'Confirm Appointment',
        icon: 'fas fa-check',
        primary: true,
        onclick: `confirmAppointment(${id})`
      },
      {
        text: 'Close',
        onclick: 'closeModal()'
      }
    ]);
  }, 1000);
}

function confirmAppointment(id) {
  // Show confirmation
  showModal('Confirm Appointment', `
    <div style="text-align: center; padding: 1rem;">
      <div style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;">‚úÖ</div>
      <p>Appointment confirmed successfully!</p>
    </div>
  `, [
    {
      text: 'Great!',
      onclick: 'closeModal()'
    }
  ]);

  // Update UI
  setTimeout(() => {
    updateAppointments();
  }, 1500);
}

function refreshAppointments() {
  // Show refreshing animation
  const btn = event.target;
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
  btn.disabled = true;

  // Simulate refresh
  setTimeout(() => {
    btn.innerHTML = originalHtml;
    btn.disabled = false;
    
    // Show success notification
    showModal('Refresh Complete', `
      <div style="text-align: center; padding: 1rem;">
        <div style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;">üîÑ</div>
        <p>Appointments updated successfully!</p>
      </div>
    `, [
      {
        text: 'OK',
        onclick: 'closeModal()'
      }
    ]);

    updateAppointments();
  }, 1500);
}

// Real-time Updates
function updateDoctorProfile() {
  // Simulate profile update
  const elements = {
    qualification: 'MD, MBBS',
    experience: '8 years',
    duty: '9:00 AM - 6:00 PM',
    rating: '4.9 ‚≠ê (127 reviews)'
  };

  Object.keys(elements).forEach(key => {
    const element = document.querySelector(`[data-doctor-${key}]`);
    if (element) {
      element.textContent = elements[key];
      element.style.animation = 'pulse 0.5s ease';
      setTimeout(() => element.style.animation = '', 500);
    }
  });
}

function updateAppointments() {
  // Simulate appointment updates
  const stats = {
    total: Math.floor(Math.random() * 50) + 20,
    pending: Math.floor(Math.random() * 10) + 1,
    confirmed: Math.floor(Math.random() * 15) + 5,
    completed: Math.floor(Math.random() * 30) + 10
  };

  Object.keys(stats).forEach(key => {
    const element = document.querySelector(`[data-appt-${key}]`);
    if (element) {
      // Animate number change
      const current = parseInt(element.textContent) || 0;
      const target = stats[key];
      animateNumber(element, current, target, 1000);
    }
  });
}

function animateNumber(element, start, end, duration) {
  const startTime = performance.now();
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Easing function
    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
    const value = Math.floor(start + (end - start) * easeOutQuart);
    
    element.textContent = value;
    
    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }
  
  requestAnimationFrame(update);
}

// Initialize real-time updates
function initRealtimeUpdates() {
  // Initial update
  updateDoctorProfile();
  updateAppointments();
  
  // Update every 30 seconds
  setInterval(() => {
    updateDoctorProfile();
    updateAppointments();
    
    // Visual feedback
    const dot = document.querySelector('.pulse-dot');
    if (dot) {
      dot.style.animation = 'none';
      setTimeout(() => dot.style.animation = 'pulse 2s infinite', 10);
    }
  }, 30000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  initRealtimeUpdates();
  
  // Add hover effects to cards
  const cards = document.querySelectorAll('.stat-card, .section-card');
  cards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-8px)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });

  // Add click animations to buttons
  const buttons = document.querySelectorAll('.btn-modern');
  buttons.forEach(button => {
    button.addEventListener('click', function(e) {
      // Ripple effect
      const ripple = document.createElement('span');
      const rect = this.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      const x = e.clientX - rect.left - size / 2;
      const y = e.clientY - rect.top - size / 2;
      
      ripple.style.cssText = `
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
        width: ${size}px;
        height: ${size}px;
        left: ${x}px;
        top: ${y}px;
      `;
      
      this.style.position = 'relative';
      this.style.overflow = 'hidden';
      this.appendChild(ripple);
      
      setTimeout(() => {
        ripple.remove();
      }, 600);
    });
  });

  console.log('üöÄ Doctor Dashboard Initialized - Modern UI with Real-time Updates');
});

// Add ripple animation
const style = document.createElement('style');
style.textContent = `
  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);
</script>

{% endblock %}